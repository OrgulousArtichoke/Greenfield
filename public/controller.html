<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>HR Game Hackathon</title>
  <script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/phaser/2.4.3/phaser.js"></script>
  <script type="text/javascript">
  var game = new Phaser.Game(450, 250, Phaser.AUTO, 'gameContainer');


    var socket = io();

    //some global vars 
    var left=false;
    var right=false;
    var up = false;
    var jump=false;
    var shoot=false;
    var playerNumber = false;
    var textRef;

    var mainState = {
      preload: function () {
        game.stage.backgroundColor = '#666';
        game.load.image('player', 'assets/player.png'); 
        game.load.image('ground', 'assets/ground.png');
        game.load.spritesheet('buttonhorizontal', 'assets/square.png',100,100);
        game.stage.disableVisibilityChange = true;
        this.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
        this.scale.setMinMax(480, 260, 1024, 768);
        this.scale.pageAlignHorizontally = true;
        this.scale.pageAlignVertically = true;
        this.scale.forceOrientation(true, false);
        this.scale.setResizeCallback(this.gameResized, this);
        this.scale.enterIncorrectOrientation.add(this.enterIncorrectOrientation, this);
        this.scale.leaveIncorrectOrientation.add(this.leaveIncorrectOrientation, this);


    // // fullscreen setup
        game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
        game.scale.fullScreenScaleMode = Phaser.ScaleManager.EXACT_FIT;

      },
      create: function () {

       socket.emit('new player', {});
        socket.on("confirmPlayer", function(data){
          if (!playerNumber){
            playerNumber = data.playerNumber;
          }
          addText(game, "Player_num: " + playerNumber +
          "\n Strength: 5");
        });

        socket.on("rejectPlayer", function(data){
          addText(game, data.message);

          console.log(data.message);
        });

        socket.on("player shot", function(data){
          onPlayerShot(data);
        });

        socket.on("player killed", onPlayerDeath);

        buttonleft = game.add.button(0, 0, 'buttonhorizontal', null, this, 0, 1, 0, 1);
            buttonleft.events.onInputDown.add(function(){left=true;});
            buttonleft.events.onInputUp.add(function(){left=false;});

        buttonjump = game.add.button(150, 0, 'buttonhorizontal', null, this, 0, 1, 0, 1);
            buttonjump.events.onInputDown.add(function(){up=true;});
            buttonjump.events.onInputUp.add(function(){up=false;});


        buttonright = game.add.button(300, 0, 'buttonhorizontal', null, this, 0, 1, 0, 1);
            buttonright.events.onInputDown.add(function(){right=true;});
            buttonright.events.onInputUp.add(function(){right=false;});

        buttonA = game.add.button(0, 100, 'buttonhorizontal', null, this, 0, 1, 0, 1);
            buttonA.events.onInputDown.add(function(){shoot=true;});
            buttonA.events.onInputUp.add(function(){shoot=false;});

      },
      update: function () {

        if (left) {
         socket.emit('left button', {});
        }
        if (right) {
          socket.emit('right button', {});      
        }
        if (up) {
         socket.emit('up button', {});
        }
        if (shoot) {
         socket.emit('shoot button', {});
        }
        if (game.input.currentPointers == 0 && !game.input.activePointer.isMouse){right=false; left=false; jump=false; shoot=false;
        } //this works around a "bug" where a button gets stuck in pressed state

      },
      enterIncorrectOrientation: function () {
          document.getElementById('orientation').style.display = 'block';
      },

      leaveIncorrectOrientation: function () {
          document.getElementById('orientation').style.display = 'none';
      }

    };



    game.state.add('main', mainState);
    game.state.start('main');

function gofull() { game.scale.startFullScreen(false);}
function addText(game, message, configObj){

  if (!configObj){
    var style = { font: 'bold 15pt Arial', fill: 'white', align: 'left', wordWrap: true, wordWrapWidth: 450};
  }else{
    var style = configObj;
  }

  var text = game.add.text(game.world.centerX, game.world.centerY, message, style);
  text.anchor.set(0.5);
  textRef = text;

}

function onPlayerDeath (){
  alert('Here is a handler for on death events.\nMaybe we\'ll want the screen to shake or make a noise or whatever')
}
function onPlayerShot (data) {
  //Callback for player shot events
  textRef.setText("Player_num: " + playerNumber +
  "\n Strength: " + data.health);
}

    </script>
  </head>
  <style type="text/css">
    body {
        margin: 0px 0px 1px 0px; /* the extra 1px allows the iOS inner/outer check to work */
        background: #000;
    }

    #orientation {
        margin: 0 auto;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-repeat: no-repeat;
        background-position: center;
        background-color: rgb(0, 0, 0);
        z-index: 999;
        display: none;
        color: white;
    }
  </style>

  <div id="orientation">
      <h1>Please rotate your device</h1>
  </div>

  <div id="gameContainer"></div>
</html>